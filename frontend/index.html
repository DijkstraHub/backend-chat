<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Frontend</title>
</head>

<body>
    <div class="center">
        <h1>Chat APP</h1>
        <h3 id="chat-header">Frontend</h3>

        <form id="chatroom-select">
            <label for="chatroom">chatroom:</label>
            <input type="text" id="chatroom" name="chatroom"></br></br>
            <input type="submit" value="Submit">
        </form></br></br>

        <textarea class="chatbox" id="chatbox" name="chatbox" rows="4" cols="15" placeholder="Welcome to chatroom"
            readonly>
        </textarea></br></br>

        <form id="chatroom-message">
            <label for="message">Message:</label>
            <input type="text" id="message" name="message"></br></br>
            <input type="submit" value="Submit">
        </form></br></br>

        <script>
            var selectedChatroom = "general";

            class Event {
                constructor(type, data) {
                    this.type = type;
                    this.data = data;
                }
            }

            function routeEvent(event) {
                if (event.type === undefined || event.data === undefined) {
                    console.error("Invalid event: " + event);
                    return;
                }
                switch (event.type) {
                    case "new_message":
                        console.log("New message: " + event.data);
                        break;
                    default:
                        console.log("Unknown event type: " + event.type);
                        break;
                }
            }

            function sendEvent(eventName, payload) {
                try {
                    const e = new Event(eventName, payload);
                    ws.send(JSON.stringify(e));
                    console.log("Event sent: " + e);
                } catch (error) {
                    console.error(error);
                }
            }

            function ChangeChatroom() {
                var newChatroom = document.getElementById("chatroom").value;
                if (selectedChatroom =! null && newChatroom != selectedChatroom) {
                    selectedChatroom = newChatroom;
                    console.log("Chatroom changed to: " + selectedChatroom);
                }
                return false;
            }

            function SendMessage() {
                try {
                    var message = document.getElementById("message");
                    if (message != null) {
                        sendEvent("send_message", message.value);
                        console.log("Message sent: " + message.value);
                    }
                } catch (error) {
                    console.error(error);
                }
                return false;
            }

            window.onload = function () {
                document.getElementById("chatroom-select").onsubmit = ChangeChatroom;
                document.getElementById("chatroom-message").onsubmit = SendMessage;

                if (window["WebSocket"]) {
                    console.log("WebSocket supported");
                    ws = new WebSocket("ws://" + document.location.host + "/ws");
                    ws.onopen = function () {
                        console.log("Connected to server");
                    };
                    ws.onmessage = function (evt) {
                        // console.log(evt.data);
                        const eventData = JSON.parse(evt.data);
                        const event = Object.assign(new Event(), eventData);
                        routeEvent(event);
                    };
                    ws.onclose = function () {
                        console.log("Disconnected from server");
                    };
                } else {
                    console.log("WebSocket not supported");
                }
            }
        </script>

        <style rel="stylesheet" type="text/css" >
            .center {
                margin: auto;
                width: 50%;
                border: 3px solid green;
                padding: 10px;
            }

            body {
                overflow: hidden;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;
                background-color: aliceblue;
            }
        </style>
    </div>
</body>

</html>